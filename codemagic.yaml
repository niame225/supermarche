# codemagic.yaml - Build Android APK signÃ© pour production

workflows:
  android-release-workflow:
    name: Build Signed APK - SupermarchÃ© App
    max_build_duration: 60
    instance_type: mac_mini_m1

    environment:
      # ðŸ”‘ RÃ©fÃ©rence au keystore configurÃ© dans Codemagic UI
      android_signing:
        - supermarche_release_keystore  # â† DOIT correspondre au nom donnÃ© dans l'UI

      flutter: stable
      vars:
        FLUTTER_VERSION: "3.19.0"
        JAVA_HOME: /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home

    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true

    scripts:
      # Ã‰TAPE 1 : Configuration Android
      - name: Set up local.properties
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > "$CM_BUILD_DIR/android/local.properties"
          echo "flutter.sdk=$FLUTTER_ROOT" >> "$CM_BUILD_DIR/android/local.properties"

      # Ã‰TAPE 2 : Nettoyage et dÃ©pendances
      - name: Flutter clean & pub get
        script: |
          flutter clean
          flutter pub get

      # Ã‰TAPE 3 : VÃ©rification v2 embedding (optionnel mais utile)
      - name: Ensure Android v2 embedding
        script: |
          MAIN_ACTIVITY="android/app/src/main/kotlin/$(grep -r "package " android/app/src/main/AndroidManifest.xml | head -1 | sed 's/.*package="//' | sed 's/".*//')/MainActivity.kt"
          if [ -f "$MAIN_ACTIVITY" ]; then
            if ! grep -q "io.flutter.embedding.android.FlutterActivity" "$MAIN_ACTIVITY"; then
              echo "âŒ ERREUR : MainActivity non compatible v2 embedding."
              exit 1
            fi
          fi

      # Ã‰TAPE 4 : Build APK signÃ© (release)
      - name: Build Signed Release APK
        script: |
          echo "ðŸš€ Construction de l'APK signÃ©..."
          flutter build apk --release --verbose

          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âŒ Ã‰chec : APK non gÃ©nÃ©rÃ©."
            exit 1
          fi

          echo "âœ… APK signÃ© crÃ©Ã© :"
          ls -lh build/app/outputs/flutter-apk/app-release.apk

      # Ã‰TAPE 5 : Info de build
      - name: Generate build info
        script: |
          cat > build_info.txt << EOF
          ========================================
          BUILD INFORMATION
          ========================================
          Date: $(date '+%Y-%m-%d %H:%M:%S')
          Flutter: $(flutter --version | head -n1)
          Commit: $CM_COMMIT
          Branch: $CM_BRANCH
          Build #: $CM_BUILD_NUMBER
          ========================================
          EOF
          cat build_info.txt

    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk
      - build_info.txt

    publishing:
      email:
        recipients:
          - niame225@gmail.com
        notify:
          success: true
          failure: true