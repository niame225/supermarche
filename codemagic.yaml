workflows:
  android-workflow:
    name: Build Android APK & AAB - SupermarchÃ© App
    max_build_duration: 60
    instance_type: mac_mini_m1

    environment:
      flutter: 3.19.0
      xcode: latest
      cocoapods: default
      groups:
        - default
      vars:
        JAVA_HOME: /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home

    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle

    scripts:
      - name: ðŸ§© Configuration de local.properties
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > "$CM_BUILD_DIR/android/local.properties"
          echo "âœ… Fichier local.properties crÃ©Ã© avec succÃ¨s"

      - name: ðŸ“¦ RÃ©cupÃ©ration des dÃ©pendances Flutter
        script: |
          flutter clean
          flutter pub get
          echo "âœ… DÃ©pendances tÃ©lÃ©chargÃ©es avec succÃ¨s"

      - name: ðŸ” Analyse du code Flutter
        script: |
          set -e
          flutter analyze || echo "âš ï¸ Avertissements dÃ©tectÃ©s (non bloquants)"

      - name: ðŸš€ Construction de l'APK Release
        script: |
          echo "ðŸ“¦ Construction de l'APK Release..."
          flutter build apk --release --verbose

          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âŒ ERREUR: APK release non crÃ©Ã© !"
            exit 1
          fi
          echo "âœ… APK Release crÃ©Ã© avec succÃ¨s"

      - name: ðŸ—ï¸ Construction du Bundle AAB
        script: |
          echo "ðŸ“¦ Construction du Bundle AAB..."
          flutter build appbundle --release --verbose

          if [ ! -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "âŒ ERREUR: AAB release non crÃ©Ã© !"
            exit 1
          fi
          echo "âœ… AAB Release crÃ©Ã© avec succÃ¨s"

      - name: ðŸ§¾ GÃ©nÃ©ration des informations de build
        script: |
          cat > build_info.txt << EOF
          ========================================
          BUILD INFORMATION - SupermarchÃ© App
          ========================================
          Date de build : $(date '+%Y-%m-%d %H:%M:%S')
          Flutter Version : $(flutter --version | head -n 1)
          Android SDK : $ANDROID_SDK_ROOT
          Commit : $CM_COMMIT
          Branche : $CM_BRANCH
          ========================================
          EOF
          cat build_info.txt

    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk
      - build/app/outputs/bundle/release/app-release.aab
      - build_info.txt

    publishing:
      email:
        recipients:
          - niame225@gmail.com
        notify:
          success: true
          failure: true
        message: |
          ðŸš€ Le build Android de *SupermarchÃ© App* s'est terminÃ© avec succÃ¨s !
          ðŸ“¦ Les fichiers APK et AAB sont disponibles dans les artifacts Codemagic.
